### 项目简介

本项目用于将“慈善捐赠台账”与“持有人份额汇总”进行关联与金额分摊，自动批量生成每个产品的“代捐说明（docx）”和“票据明细（xlsx）”，并将明细表插入到说明文档的指定占位位置。


### 作者与版本

- 作者：songtaomocha
- 版本：1.0版


### 主要特性

- 读取多份源表，自动探测表头位置与列名同义词
- 按份额比例分摊捐赠金额（四舍五入两位小数，最后一行承接尾差）
- 基于模板批量渲染 docx，并在占位符处插入表格明细
- 结果与日志分目录输出，避免文件名冲突自动追加序号


### 运行环境

- Python ≥ 3.8（推荐 3.10+）
- 操作系统：macOS/Windows/Linux


### 依赖安装

项目已提供 `requirements.txt`：

```bash
python3 -m pip install -r requirements.txt
```

说明：
- `pandas>=2.0.0`
- `openpyxl>=3.1.0` 用于读写 xlsx
- `xlrd==1.2.0` 仅用于读取 xls（新版 xlrd 不再支持 xls）
- `python-docx>=0.8.11` 用于处理 docx


### 目录结构

```
慈善代捐说明/
  ├─ main.py                     # 入口脚本
  ├─ requirements.txt
  ├─ scr/                        # 内部模块
  │   ├─ allocation.py           # 金额分摊算法
  │   ├─ docx_utils.py           # 模板替换与明细表插入
  │   ├─ excel_reader.py         # Excel 读取与表头探测
  │   ├─ io_utils.py             # 路径、扫描、日志、命名去冲突
  │   ├─ orchestrator.py         # 调度主流程
  │   └─ text_utils.py           # 文本与金额格式化工具
  ├─ Template/
  │   └─ 代捐说明模版文件.docx    # 模板（需存在）
  ├─ 数据源/                      # 放置输入数据
  │   ├─ 慈善*.xls[x]            # 含“慈善”的台账文件（xls/xlsx）
  │   └─ *持有人份额汇总信息查询*.xlsx
  └─ 输出/                        # 运行后自动生成
      ├─ 代捐说明/               # 生成的 docx
      └─ 明细表/                 # 生成的 xlsx
```


### 输入数据规范

- 文件放在 `数据源/` 目录。
- 文件名约定（用于自动发现文件）：
  - 慈善台账：文件名包含“慈善”，后缀 `.xls` 或 `.xlsx`
  - 份额文件：文件名包含“持有人份额汇总信息查询”，后缀 `.xlsx`

列名同义词（无需完全一致，程序会做同义匹配）：
- 慈善台账（必须字段）：
  - 产品名称：{产品名称, 产品, 产品全称}
  - 对手方：{对手方, 对手方名称}
  - 发生金额：{发生金额, 金额, 捐赠金额}
- 份额文件（必须字段）：
  - 产品名称：{产品名称, 产品, 产品全称}
  - 客户名称：{客户名称, 客户, 持有人名称, 投资者名称}
  - 当前份额：{当前份额, 份额, 持有份额}

表头自动探测：
- 默认优先尝试第 2 行（1-based）作为表头；若失败，会无表头读入并在前 6 行中自动探测最可能的表头行。


### 模板占位符

模板文件：`Template/代捐说明模版文件.docx`

支持以下占位符（原样文本匹配）：
- `#产品名称#`
- `#对手方#`
- `#发生金额#`（已按千分位与两位小数格式化）
- `#明细表#`（插入票据明细的表格位置；若未找到，将把表格追加到文末）

票据明细表（插入到文档和导出到 xlsx）的表头：
- 序号
- 票据抬头（实际捐赠人姓名）
- 票据金额（实际捐赠金额（元））


### 分摊规则

- 对每个产品，将慈善台账中的捐赠金额按持有人份额比例进行分摊。
- 计算时对每一行金额四舍五入到两位小数；为保证合计精确等于总额，最后一行承接尾差。
- 份额缺失或为 0 视为 0；若某产品在份额文件中存在但不在慈善台账中出现，则该产品的分摊金额按 0 处理并给出日志告警。


### 使用方法

1) 放置数据与模板
- 确保模板文件存在于 `Template/代捐说明模版文件.docx`
- 将源数据文件放入 `数据源/`

2) 安装依赖
```bash
python3 -m pip install -r requirements.txt
```

3) 运行
```bash
python3 main.py
```

运行结束后，终端会输出汇总统计；完整日志写入 `logs/` 目录。


### 输出结果

- 代捐说明：`输出/代捐说明/{对手方}_代捐说明_{产品简称}.docx`（若对手方缺失，则为 `代捐说明_{产品简称}.docx`）
- 票据明细：`输出/明细表/票据明细_{产品简称}.xlsx`

命名冲突处理：
- 如目标文件已存在且不覆盖，会自动在文件名后追加 `_2`, `_3`, ... 避免覆盖。


### 日志与控制台输出

- 日志：`logs/run-YYYYMMDD-HHMMSS.log`
- 控制台：输出简要统计（文件数量、记录数、成功/失败数等）
- 提示：运行时会隐藏 `openpyxl` 的部分用户级警告，不影响结果。


### 错误处理

- 缺少模板：直接报错（FileNotFoundError）
- 慈善台账同一产品重复：抛出 `DuplicateProductError`
- 其他异常：控制台提示“运行失败，详情见日志”，并在日志中记录完整堆栈


### 常见问题（FAQ）

**Q: 读取失败或“无法定位表头行”？**
- 请检查源文件的第一至第六行是否包含必要列名之一（同义词也可以）。
- 若表头行前存在说明行或空行，请将真实表头行靠前。

**Q: xls 文件读取失败？**
- 请确认已安装 `xlrd==1.2.0`（本项目已固定该版本以支持 xls）。

**Q: 明细表没有插入到模板指定位置？**
- 请确认模板中存在文本占位符 `#明细表#`；若找不到占位符，程序会将表格追加到文末并在日志中给出告警。

**Q: 文件名包含特殊字符导致保存失败？**
- 程序会自动替换非法文件名字符（如 `\\/:*?"<>|` 等），若仍失败请检查磁盘权限与路径长度限制。


### 扩展与定制

- 列名同义词：可在 `scr/excel_reader.py` 中调整 `CHARITY_REQUIRED` 与 `HOLDING_REQUIRED`
- 产品简称提取规则：位于 `scr/text_utils.py` 的 `extract_short_name`（当前示例按“鼎…集”模式提取，不匹配时回退为全名）
- 分摊精度与规则：位于 `scr/allocation.py` 的 `allocate_proportional`
- 表格样式与字号行距：位于 `scr/docx_utils.py`，包括样式、列宽、对齐等

注：以上均为代码级定制，修改前请先做好备份并确保熟悉 Python。


### 版权与声明

本项目用于内部流程自动化示例，请根据实际业务规范调整和替换。

